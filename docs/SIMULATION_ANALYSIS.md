# DC仿真模型架构分析

## 📋 总体架构

这是一个基于 **SimPy 离散事件仿真（DES）**的配送中心运营优化模型，模拟4种运营时长方案对SLA和运营效率的影响。

---

## 🎯 仿真实体（Entities）

### 1️⃣ **Truck（卡车）**
```python
属性：
- id: 唯一标识
- category: 'FG' 或 'R&P'
- direction: 'Inbound' 或 'Outbound'
- pallets: 托盘数量（20-35）
- scheduled_time: 预定时间
- actual_arrival_time: 实际到达时间
- service_start_time: 服务开始时间
- service_end_time: 服务结束时间
- departure_deadline: 发运截止时间（仅FG）
```

**作用**：代表物流卡车，承载入库/出库任务

---

### 2️⃣ **Order（订单）**
```python
属性：
- id: 唯一标识
- pallets: 托盘数量（80-200）
- order_time: 下单时间
- departure_time: 发运时间
- cutoff_time: 截单时间
- status: 'Pending', 'Processing', 'Completed', 'Missed'
- completion_time: 完成时间
```

**作用**：FG出库订单，用于SLA合规性检查

---

### 3️⃣ **TrailerBuffer（挂车缓冲区）**
```python
属性：
- category: 'FG' 或 'R&P'
- max_capacity: 最大容量（托盘）
- current_pallets: 当前托盘数
- queue: FIFO队列
- overflow_count: 溢出次数
- total_overflow_pallets: 溢出托盘总数

方法：
- add(): 添加托盘
- release(): 释放托盘（FIFO）
- get_occupancy_rate(): 占用率
```

**作用**：模拟DC关闭时的挂车缓冲区累积

---

### 4️⃣ **FTEManager（人力资源管理器）**
```python
属性：
- total_fte: 总人力（125人）
- efficiency_params: 效率参数

方法：
- get_efficiency(): 获取随机效率（正态分布）
- allocate_fte(): 动态分配人力（按工作量）
```

**作用**：模拟人员效率的随机波动

---

### 5️⃣ **KPICollector（KPI收集器）**
```python
收集数据：
- buffer_overflows: 缓冲区溢出事件
- truck_wait_times: 卡车等待时间
- sla_misses: SLA错过事件
- completed_orders: 完成订单
- midnight_backlogs: 午夜积压
- hourly_buffer_occupancy: 每小时缓冲区占用率
```

**作用**：收集和分析仿真KPI数据

---

## ⚙️ 核心进程（Processes）

仿真中运行7个并发进程：

### 1️⃣ **factory_production_process（工厂生产）** ×2个
```python
频率: 每小时
触发条件: 24/7连续运行
行为:
  - 生成泊松分布的托盘数（R&P: λ=23, FG: λ=46）
  - 如果DC关闭 → 进入缓冲区（可能溢出）
  - 如果DC开启 → 直接入库处理
```

---

### 2️⃣ **buffer_release_process（缓冲区释放）** ×1个
```python
频率: 每30分钟
触发条件: DC开门时
行为:
  - 检查缓冲区是否有托盘
  - 释放托盘（R&P: 100/次, FG: 150/次）
  - 启动入库处理进程
```

---

### 3️⃣ **truck_arrival_process（卡车到达）** ×1个
```python
频率: 每小时
触发条件: DC开门 & 该小时有到达数据
行为:
  - 泊松到达：num_trucks ~ Poisson(λ_hour)
  - 对每辆卡车：
    * 生成卡车属性（FG 67%, R&P 33%）
    * 添加指数延迟（平均15分钟）
    * 启动出库处理进程
```

---

### 4️⃣ **fg_order_generator（FG订单生成）** ×1个
```python
频率: 按发运时间表（9个发运窗口/天）
触发条件: 发运前2-5小时下单
行为:
  - 生成订单（80-200托盘）
  - 设置截单时间（发运前2小时）
  - 启动订单处理进程
```

---

### 5️⃣ **inbound_process（入库处理）** ×N个
```python
资源需求: Reception码头（时变容量）
行为:
  1. 检查可用码头（时变）
  2. 请求码头资源
  3. 获取随机效率（正态分布）
  4. 处理时间 = 托盘数 / 效率
  5. 释放资源并记录KPI
```

---

### 6️⃣ **outbound_process（出库处理）** ×N个
```python
资源需求: Loading码头（时变容量）
行为:
  1. 检查可用码头（时变）
  2. 请求码头资源
  3. 记录等待时间
  4. 装车时间 = 托盘数 / 效率
  5. 检查SLA（FG订单）
  6. 释放资源并记录KPI
```

---

### 7️⃣ **midnight_backlog_checker（午夜积压检查）** ×1个
```python
频率: 每天午夜
行为:
  - 统计待处理订单数
  - 统计待处理托盘数
  - 记录积压情况
```

---

### 8️⃣ **buffer_monitor（缓冲区监控）** ×1个
```python
频率: 每小时
行为:
  - 记录当前缓冲区占用率
  - 用于后续分析
```

---

### 9️⃣ **update_dock_capacity_process（码头容量更新）** ×1个
```python
频率: 每小时
行为:
  - 获取当前小时的总码头容量
  - 按FG/R&P比例（70%/30%）分配
  - 更新current_dock_capacity
```

---

## 📊 参数配置（Parameters）

### ✅ **基于实际数据的参数（13个）**

#### 1. **效率参数**（来源：KPI sheet 2025.xlsx）
```python
'efficiency': {
    'rp_mean': 5.81,      # 11个月平均
    'rp_std': 0.416,      # 11个月标准差
    'fg_mean': 3.5,       # 估算（调整后）
    'fg_std': 0.5         # 估算
}
```
**数据质量**: ⭐⭐⭐⭐⭐（R&P真实数据）/ ⭐⭐⭐（FG估算）

---

#### 2. **人力资源**（来源：KPI sheet 实际工时）
```python
'fte_total': 125,         # 21,632h/月 ÷ 176h/人
'fte_allocation': {
    'rp_baseline': 28,    # 4,538h ÷ 176
    'fg_baseline': 97     # 17,094h ÷ 176
}
```
**数据质量**: ⭐⭐⭐⭐⭐（实际工时反推）

---

#### 3. **时变码头容量**（来源：48周Timeslot数据）
```python
'hourly_dock_capacity': {
    'loading': {          # 48周统计
        6: 6, 7: 8, ..., 23: 4
    },
    'reception': {
        6: 5, 7: 5, ..., 23: 1
    },
    'fg_ratio': 0.70,     # 业务量比例
    'rp_ratio': 0.30
}
```
**数据质量**: ⭐⭐⭐⭐⭐（48周×24小时实际数据）

---

#### 4. **卡车到达率**（来源：Total Shipments 2025.xlsx）
```python
'truck_arrival_rates': {  # 11月Outbound数据
    6: 2.5,  # λ（泊松参数）
    7: 3.2,
    ...
    16: 5.1,  # 高峰
    23: 0.5
}
```
**数据质量**: ⭐⭐⭐⭐（11月实际到达统计）

---

### 📐 **计算推导的参数（4个）**

#### 5. **工厂生产速率**（反推自需求数据）
```python
'factory_production': {
    'rp_rate': 23,        # 16,500托盘/月 ÷ 30天 ÷ 24h
    'fg_rate': 46         # 33,000托盘/月 ÷ 30天 ÷ 24h
}
```
**计算依据**: Total Shipments Inbound平均值

---

#### 6. **缓冲区容量**（基于6小时累积+20%余量）
```python
'buffer_capacity': {
    'rp_trailers': 15,    # (23×6÷33) × 1.2 = 15
    'fg_trailers': 20,    # (46×6÷33) × 1.2 = 20
    'pallets_per_trailer': 33
}
```
**计算依据**: DC关闭期间累积量估算

---

### ⚙️ **业务规则参数（3个）**

#### 7. **FG发运时间表**（业务规定）
```python
'fg_departure_schedule': [8, 10, 12, 14, 16, 18, 20, 22, 24]  # 9个窗口/天
'loading_lead_time': 2  # 发运前2小时截单
```
**来源**: 业务流程规定

---

## 🔄 仿真流程图

```
开始（初始化环境）
  │
  ├─ 启动工厂生产进程（R&P）──┐
  ├─ 启动工厂生产进程（FG）───┤
  ├─ 启动缓冲区释放进程 ──────┤
  ├─ 启动卡车到达进程 ────────┤  7个并发进程
  ├─ 启动FG订单生成器 ────────┤  同时运行
  ├─ 启动午夜积压检查器 ──────┤
  └─ 启动缓冲区监控器 ────────┘
  │
  ▼
运行30天（720小时）
  │
  ├─ 每小时：
  │   ├─ 更新码头容量（时变）
  │   ├─ 工厂生成托盘（泊松）
  │   ├─ 卡车到达（泊松）
  │   └─ 检查缓冲区占用率
  │
  ├─ DC开门时：
  │   ├─ 释放缓冲区托盘
  │   ├─ 处理入库（请求Reception码头）
  │   └─ 处理出库（请求Loading码头）
  │
  ├─ DC关闭时：
  │   └─ 托盘进入缓冲区（可能溢出）
  │
  └─ 每个发运窗口：
      ├─ 生成FG订单
      ├─ 处理订单（装车）
      └─ 检查SLA（是否错过截止时间）
  │
  ▼
收集KPI并生成报告
  │
  └─ 输出：Excel + 可视化图表
```

---

## 📈 数据流向

### **输入数据**
```
1. KPI sheet 2025.xlsx
   ├─ R&P效率（11个月）
   ├─ FG效率（11个月）
   └─ 实际工时数据

2. Total Shipments 2025.xlsx
   ├─ Inbound需求分布
   └─ Outbound每小时到达率

3. Timeslot数据（48周×W*.xlsx）
   ├─ Loading码头容量（24小时）
   └─ Reception码头容量（24小时）
```

### **仿真处理**
```
随机过程：
├─ 泊松到达：卡车、工厂生产
├─ 指数延迟：卡车到达间隔
├─ 正态分布：人员效率波动
└─ 均匀分布：订单托盘数、下单时间偏移

资源竞争：
├─ FG_Reception码头（时变容量）
├─ FG_Loading码头（时变容量）
├─ RP_Reception码头（时变容量）
└─ RP_Loading码头（时变容量）

队列管理：
├─ 码头等待队列（SimPy Resource）
└─ 缓冲区FIFO队列
```

### **输出数据**
```
Excel结果：
├─ simulation_results_comparison.xlsx（4场景对比）
└─ simulation_details_*.xlsx（详细数据）
   ├─ Buffer_Overflows（缓冲区溢出）
   ├─ Truck_Wait_Times（等待时间）
   ├─ SLA_Misses（SLA错过）
   ├─ Completed_Orders（完成订单）
   └─ Midnight_Backlogs（午夜积压）

可视化：
└─ simulation_results_visualization.png（综合对比图）
```

---

## 🎲 关键假设与简化

### ✅ **合理假设**
1. **泊松到达**：卡车到达、工厂生产符合泊松过程
2. **正态效率**：人员效率服从正态分布（截断避免负值）
3. **FIFO缓冲区**：先进先出队列管理
4. **时变容量**：码头容量按小时动态变化

### ⚠️ **简化处理**
1. **只模拟Outbound卡车到达**：Inbound由工厂进程单独建模
2. **固定托盘数范围**：20-35（卡车），80-200（订单）
3. **忽略设备故障**：假设设备100%可用
4. **简化人力分配**：按工作量比例分配，不考虑班次

---

## 📊 参数来源汇总表

| 参数类别 | 参数名称 | 数值 | 来源 | 质量 |
|---------|---------|------|------|------|
| **效率** | R&P效率 | 5.81±0.416 | KPI sheet 11个月 | ⭐⭐⭐⭐⭐ |
| **效率** | FG效率 | 3.5±0.5 | 估算+调整 | ⭐⭐⭐ |
| **人力** | 总FTE | 125 | 工时反推 | ⭐⭐⭐⭐⭐ |
| **码头** | 时变容量 | 按小时变化 | 48周Timeslot | ⭐⭐⭐⭐⭐ |
| **到达** | 每小时λ | 0.5-5.1 | 11月Shipments | ⭐⭐⭐⭐ |
| **生产** | R&P速率 | 23托盘/h | 需求反推 | ⭐⭐⭐⭐ |
| **生产** | FG速率 | 46托盘/h | 需求反推 | ⭐⭐⭐⭐ |
| **缓冲** | R&P挂车 | 15辆 | 6h累积+20% | ⭐⭐⭐ |
| **缓冲** | FG挂车 | 20辆 | 6h累积+20% | ⭐⭐⭐ |
| **业务** | 发运窗口 | 9个/天 | 业务规定 | ⭐⭐⭐⭐⭐ |

**数据质量说明**：
- ⭐⭐⭐⭐⭐：实际运营数据
- ⭐⭐⭐⭐：统计推导
- ⭐⭐⭐：合理估算

---

## 🎯 仿真目标

**主要问题**：缩短DC运营时间对SLA的影响？

**评估场景**：
- Baseline: 18小时（06:00-24:00）
- Scenario 1: 16小时（07:00-23:00）
- Scenario 2: 14小时（08:00-22:00）
- Scenario 3: 12小时（08:00-20:00）

**关键KPI**：
1. SLA合规率（目标：>99%）
2. 缓冲区溢出次数（目标：0）
3. 卡车平均等待时间
4. 午夜订单积压量
5. 资源利用率

---

## 💡 模型优势

1. ✅ **数据驱动**：基于11个月实际运营数据
2. ✅ **时变建模**：码头容量按小时动态变化
3. ✅ **随机性**：捕捉效率波动、到达不确定性
4. ✅ **资源竞争**：真实模拟码头资源争用
5. ✅ **多场景对比**：4个方案并行评估
6. ✅ **详细KPI**：多维度性能追踪

---

## 🔧 可改进点

1. **更精细的效率建模**：考虑学习曲线、疲劳因素
2. **动态人力调度**：模拟班次、加班
3. **设备故障**：引入故障率和维修时间
4. **Inbound建模**：完整模拟外部Inbound卡车
5. **需求预测**：整合更多月份数据，识别季节性
6. **订单优先级**：区分紧急订单和普通订单

---

**版本**: 2.0  
**更新日期**: 2026-01-08  
**总代码行数**: 1028行  
**仿真时长**: 30天（720小时）  
**并发进程数**: 9个
