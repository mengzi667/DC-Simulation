# 到达分布与缓冲区验证报告

## 执行日期
2026年1月8日

## 数据来源
- Total Shipments 2025.xlsx
- Outbound Shipments 2025（36,480条记录）
- Inbound Shipments 2025（17,103条记录）
- 时间跨度：2025年全年（306天）

---

## 核心发现

### 🔴 关键发现1：卡车到达不符合泊松分布！

#### FG卡车到达

| 指标 | 实际值 | 泊松分布理论值 | 结论 |
|-----|--------|---------------|------|
| 均值 λ | 3.17 卡车/小时 | - | - |
| 方差 | 1.51 | **应≈3.17** | ❌ |
| 方差/均值比 | **0.477** | **1.0** | ❌ 差距53% |
| 卡方检验 p值 | 0.0000 | >0.05 | ❌ 拒绝 |
| K-S检验 p值 | 0.0000 | >0.05 | ❌ 拒绝 |

**统计结论**：
- ❌ **FG到达显著不符合泊松分布**
- 方差仅为均值的**47.7%**（理论应为100%）
- 到达比泊松分布**更规律、更可预测**

#### R&P卡车到达

| 指标 | 实际值 | 泊松分布理论值 | 结论 |
|-----|--------|---------------|------|
| 均值 λ | 1.50 卡车/小时 | - | - |
| 方差 | 0.45 | **应≈1.50** | ❌ |
| 方差/均值比 | **0.304** | **1.0** | ❌ 差距70% |
| 卡方检验 p值 | 0.0000 | >0.05 | ❌ 拒绝 |
| K-S检验 p值 | 0.0000 | >0.05 | ❌ 拒绝 |

**统计结论**：
- ❌ **R&P到达更显著不符合泊松分布**
- 方差仅为均值的**30.4%**（理论应为100%）
- 到达**高度规律化**，可能有严格的预约制度

---

### ✅ 关键发现2：缓冲区容量充足

#### FG缓冲区

| 指标 | 数值 |
|-----|-----|
| **当前配置** | 20挂车 × 33托盘 = **660托盘** |
| 平均需求 | 79 托盘/小时 |
| **95%峰值** | **135 托盘** (20.5%利用率) |
| **99%峰值** | **175 托盘** (26.5%利用率) |
| 历史最大值 | 609 托盘 (92.3%利用率) |
| **安全余量** | **73.5%** ✅ |

**结论**：
- ✅ **容量非常充足**
- 99%时段仅使用26.5%容量
- 即使历史最大值（609托盘）也未溢出
- **可能配置过大**

#### R&P缓冲区

| 指标 | 数值 |
|-----|-----|
| **当前配置** | 15挂车 × 33托盘 = **495托盘** |
| 平均需求 | 39 托盘/小时 |
| **95%峰值** | **68 托盘** (13.7%利用率) |
| **99%峰值** | **85 托盘** (17.2%利用率) |
| 历史最大值 | 622 托盘 (125.7%利用率) ⚠️ |
| **安全余量** | **82.8%** ✅ |

**结论**：
- ✅ **容量充足**（99%时段）
- ⚠️ **但历史最大值超容量25.7%！**
- 可能存在过**1次极端事件**（622托盘）
- 需要确认该事件是否为数据异常

---

## 对仿真模型的影响分析

### 影响1：到达模型不准确

#### 当前模型问题
```python
# 当前使用泊松分布
num_arrivals = np.random.poisson(arrival_rates[category][hour])
```

**问题**：
- 泊松分布假设方差=均值
- 实际方差仅为均值的**30-48%**
- **高估了到达的随机性**

#### 对结果的影响

**积极方面**（当前模型偏保守）：
- ✅ 泊松分布会产生更多峰值
- ✅ 等待时间估计**偏悲观**（实际会更短）
- ✅ 码头利用率估计**偏高**（实际更低）
- ✅ **仿真结果是保守估计，实际运营可能更好**

**消极方面**（不够准确）：
- ❌ 无法准确反映实际到达模式
- ❌ 可能错过真实的瓶颈点
- ❌ 场景对比可能不够精准

---

### 影响2：缓冲区验证结果

#### FG缓冲区
- ✅ 当前660托盘**配置充足**
- 建议：可以考虑减少到**400-500托盘**（12-15挂车）
- 节省空间/成本，仍有足够安全余量

#### R&P缓冲区
- ✅ 当前495托盘**基本充足**
- ⚠️ 注意历史最大622托盘的异常事件
- 建议：**保持当前配置**（安全余量充足）
- 或增加应急措施处理极端情况

---

## 建议的模型改进

### 优先级1：修正到达分布（🔴 高优先级）

#### 方案A：负二项分布（推荐）
```python
# 负二项分布可以模拟 Var < Mean 的情况
# 通过调整参数 r 和 p
r = lambda_hat / (1 - var_mean_ratio)  # r控制离散度
p = 1 - var_mean_ratio
num_arrivals = np.random.negative_binomial(r, p)
```

**优点**：
- 可以精确匹配均值和方差
- 理论基础扎实
- 计算高效

**参数估计**：
```python
# FG: λ=3.17, Var/Mean=0.477
r_fg = 3.17 / (1 - 0.477) = 6.06
p_fg = 1 - 0.477 = 0.523

# R&P: λ=1.50, Var/Mean=0.304  
r_rp = 1.50 / (1 - 0.304) = 2.16
p_rp = 1 - 0.304 = 0.696
```

#### 方案B：混合模型（更准确）
```python
# 80%预约到达（确定性） + 20%临时到达（泊松）
scheduled_ratio = 0.8
lambda_scheduled = arrival_rates[category][hour] * scheduled_ratio
lambda_random = arrival_rates[category][hour] * (1 - scheduled_ratio)

# 预约到达（近似确定）
num_scheduled = int(lambda_scheduled + 0.5)  # 四舍五入

# 临时到达（泊松）
num_random = np.random.poisson(lambda_random)

num_arrivals = num_scheduled + num_random
```

**优点**：
- 更符合实际运营（预约系统）
- 可以单独调整两类到达
- 可解释性强

#### 方案C：经验分布（最准确，但复杂）
```python
# 直接使用实际数据的经验分布
# 从历史到达数据中随机抽样
historical_arrivals = load_historical_data(category, hour)
num_arrivals = np.random.choice(historical_arrivals)
```

**优点**：
- 100%符合实际数据
- 不需要分布假设

**缺点**：
- 需要大量历史数据
- 计算稍慢
- 难以外推到新场景

---

### 优先级2：验证缓冲区参数来源（🟡 中优先级）

**需要确认的问题**：
1. 15/20挂车的配置依据是什么？
   - ✅ 基于物理场地限制？
   - ✅ 基于历史数据？
   - ❌ 还是假设值？

2. 33托盘/挂车是标准值吗？
   - 需要确认挂车实际容量
   - 是否所有挂车都是33托盘？

3. R&P的622托盘极端值
   - 确认是否为数据错误
   - 如果真实，需要应急预案

---

### 优先级3：其他参数精细化（🟢 低优先级）

**可选改进**：
- 按时段细分到达率（早/中/晚高峰）
- 考虑星期效应（周一 vs 周五）
- 季节性调整（淡旺季）
- 到达时间的分钟级建模（不只是小时）

---

## 立即行动建议

### 第1步：更新到达分布模型（必做）

**代码修改位置**：`dc_simulation.py` 第613行

**当前代码**：
```python
num_arrivals = np.random.poisson(arrival_rates[category][hour])
```

**建议修改为**（方案A - 负二项分布）：
```python
# 使用负二项分布（Var < Mean）
if category == 'FG':
    r, p = 6.06, 0.523  # 基于实际数据估计
elif category == 'R&P':
    r, p = 2.16, 0.696
    
num_arrivals = np.random.negative_binomial(int(r), p)
```

**或修改为**（方案B - 混合模型，更推荐）：
```python
# 预约+临时混合模型
scheduled_ratio = 0.75  # 75%预约，25%临时
lambda_hour = arrival_rates[category][hour]

# 预约到达（近似确定）
num_scheduled = int(lambda_hour * scheduled_ratio + 0.5)

# 临时到达（泊松）
num_random = np.random.poisson(lambda_hour * (1 - scheduled_ratio))

num_arrivals = num_scheduled + num_random
```

---

### 第2步：重新运行仿真对比

**运行两个版本**：
1. 保留当前泊松分布版本（作为基准）
2. 使用新分布版本（改进模型）

**对比指标**：
- 平均等待时间
- 队列长度分布
- 码头利用率
- SLA达成率

**预期差异**：
- 新模型的峰值负荷应更低
- 等待时间应更短
- 码头利用率应更平稳

---

### 第3步：文档更新

**需要更新的文档**：
1. `PARAMETER_DATA_SOURCES.md` - 添加到达分布验证结果
2. `DC_SIMULATION_SUMMARY.md` - 更新到达模型说明
3. 创建 `ARRIVAL_DISTRIBUTION_CORRECTION.md` - 记录修正过程

---

## 生成文件清单

### 数据文件
1. ✅ `arrival_buffer_validation_report.txt` - 完整分析报告
2. ✅ `outputs/figures/arrival_poisson_validation.png` - 可视化验证图表

### 代码文件  
3. ✅ `src/validate_arrival_and_buffer.py` - 验证分析脚本

### 文档文件
4. ✅ `docs/ARRIVAL_BUFFER_VALIDATION_QUESTIONS.md` - 问题分析文档
5. ✅ `docs/ARRIVAL_BUFFER_VALIDATION_REPORT.md` (本文件) - 验证报告总结

---

## 总结表

| 方面 | 发现 | 影响 | 建议 |
|-----|------|------|------|
| **FG到达分布** | ❌ 不是泊松<br>Var/Mean=0.48 | 🟡 高估随机性<br>结果偏保守 | 🔴 使用负二项<br>或混合模型 |
| **R&P到达分布** | ❌ 不是泊松<br>Var/Mean=0.30 | 🟡 高估随机性<br>结果偏保守 | 🔴 使用负二项<br>或混合模型 |
| **FG缓冲区** | ✅ 容量充足<br>99%利用率26.5% | 🟢 安全余量73.5%<br>可能过大 | 🟡 可考虑减少<br>到12-15挂车 |
| **R&P缓冲区** | ✅ 基本充足<br>99%利用率17.2% | 🟢 安全余量82.8%<br>⚠️ 历史max超容量 | 🟢 保持当前配置<br>监控极端事件 |

---

## 关键结论

### 🔴 到达分布（Critical）
- **当前模型错误**：使用泊松分布但实际不符合
- **实际模式**：到达比泊松分布更规律（方差小）
- **模型影响**：当前结果**偏保守**，实际运营应该更好
- **必须修正**：建议使用负二项分布或混合模型

### ✅ 缓冲区容量（Validated）
- **FG**：660托盘充足，有73.5%安全余量
- **R&P**：495托盘充足，有82.8%安全余量
- **配置合理**：基于实际数据验证，无需调整
- **注意**：R&P有1次极端值（622托盘），需确认

### 📊 仿真可信度
- **保守估计**：当前结果是悲观场景
- **真实性能**：实际运营可能优于仿真
- **改进价值**：修正到达分布后结果更准确
- **决策安全**：即使当前模型，结论仍然可靠

---

**报告版本**: 1.0  
**完成日期**: 2026年1月8日  
**状态**: ✅ 验证完成，建议修正到达分布模型
