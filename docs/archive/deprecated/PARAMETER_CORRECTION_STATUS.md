# 参数修正进度状态

## 更新日期
2026年1月8日（最新更新）

## 概述
本文档记录DC仿真模型中假设参数的识别和修正进度。

---

## ✅ 已完成修正

### 1. 卡车到达分布（优先级：🔴 CRITICAL）

**问题发现**：
- 原模型使用泊松分布假设卡车随机到达
- 该假设未经实际数据验证

**数据验证**：
- 实际数据：Total Shipments 2025.xlsx - Outbound（306天，6,850观测）
- 统计检验：卡方检验、K-S检验、方差-均值比检验

**验证结果**：
```
FG卡车到达：
- 均值：3.17 辆/小时
- 方差/均值：0.477（泊松应为1.0）
- 卡方检验 p<0.0001 → 拒绝泊松分布
- K-S检验 p<0.0001 → 拒绝泊松分布

R&P卡车到达：
- 均值：1.50 辆/小时
- 方差/均值：0.304（泊松应为1.0）
- 卡方检验 p<0.0001 → 拒绝泊松分布
- K-S检验 p<0.0001 → 拒绝泊松分布
```

**关键洞察**：
- 实际到达比泊松分布**更规律**（方差<均值）
- 说明存在预约/时段系统
- 原模型**高估了到达的随机性**

**修正方案**：
- 采用混合模型：75%预约到达（确定性）+ 25%临时到达（泊松）
- 更符合实际运营模式
- 代码位置：`dc_simulation.py` 第610行

**影响评估**：
- 原模型结果偏保守（悲观）
- 修正后等待时间将更短
- 修正后码头利用率更平稳

**状态**：✅ 已修正（2026年1月8日）

---

### 2. 码头容量分配（优先级：🔴 CRITICAL）

**问题发现**：
- 原模型使用70:30比例假设分配总码头容量给FG和R&P
- 该假设基于业务量占比，但未考虑装卸复杂度差异

**数据来源**：
- 实际数据：Timeslot W1-W48.xlsx（48周）
- 包含FG/R&P明确分类

**实际发现**：
```
FG Loading（出库）：
- 一致使用 1 个码头（6h-23h）
- 说明FG出库标准化程度高

R&P Loading（出库）：
- 使用 3-6 个码头（变化大）
- 高峰时段（7h, 11h, 13h, 14h）需要 6 个码头
- 说明R&P出库复杂度更高，需要更多资源

FG Reception（入库）：
- 主要使用 2 个码头（6h-21h）
- 晚间减少到 1 个（22h），0 个（23h）

R&P Reception（入库）：
- 一致使用 1 个码头（6h-23h）
```

**容量对比**：
| 业务类型 | 业务量占比 | Loading码头占比 | 比例差异 |
|---------|-----------|----------------|---------|
| FG | 69.8% | ~14% (1/7) | **-55.8%** |
| R&P | 30.2% | ~86% (6/7) | **+55.8%** |

**关键洞察**：
- R&P虽然业务量仅占30%，但Loading码头需求占86%
- 说明R&P装车复杂度远高于FG（可能是混载、非标托盘等）
- **之前的70:30假设严重低估了R&P的码头约束**

**修改内容**：
1. `src/analyze_hourly_capacity.py`：
   - 移除70:30分配逻辑
   - 分别统计FG和R&P的Loading/Reception容量
   - 输出分类后的小时级统计

2. `src/dc_simulation.py`：
   - 更新`SYSTEM_PARAMETERS['hourly_dock_capacity']`结构
   - 从总容量+比例 → FG/R&P分离的实际容量字典
   - 更新`_init_resources()`和`update_dock_capacity_process()`
   - 使用实际数据而非计算比例

**验证结果**：
- ✅ 代码无语法错误
- ✅ 仿真成功运行（4场景×3重复）
- ✅ SLA遵守率 100%（所有场景）
- ✅ 平均等待时间 74-87小时（随场景变化）

**生成文件**：
- `dock_capacity_hourly_analysis.txt`：详细的小时级容量统计
- `dock_capacity_by_hour.png`：可视化对比图
- `docs/PARAMETER_DATA_SOURCES.md`：问题分析文档
- `docs/UPDATED_PARAMETERS.md`：参数修正总结

---

### 3. 托盘分布（优先级：🟡 HIGH）✅ 已完成

**问题发现**：
- 原模型使用20-35托盘的均匀整数分布
- 假设所有卡车托盘数相似，未区分FG和R&P

**数据来源**：
- 实际数据：Total Shipments 2025.xlsx
- 工作表：Outbound Shipments 2025 + Inbound Shipments 2025
- 数据量：33,280批次（FG: 22,276, R&P: 11,004）

**实际发现**：
```
总体分布（33,280批次）：
- 均值: 27.6 托盘/批次
- 中位数: 24.0
- 标准差: 12.0
- 范围: 1 - 560

FG分布（22,276批次，66.9%）：
- 均值: 30.0 托盘/批次
- 中位数: 33.0
- 标准差: 12.3
- 范围: 1 - 276
- 众数: 32.9（核密度估计）
- 特征: 分布较集中，33托盘出现频率最高

R&P分布（11,004批次，33.1%）：
- 均值: 22.7 托盘/批次
- 中位数: 22.0
- 标准差: 9.7
- 范围: 1 - 560
- 众数: 22.3（核密度估计）
- 特征: 22托盘出现频率极高（中位数=25%分位=75%分位）
```

**关键洞察**：
1. **FG托盘数更高**：平均30托盘 vs R&P的22.7托盘
2. **FG变异性更大**：标准差12.3 vs R&P的9.7
3. **R&P高度标准化**：中位数=Q25=Q75=22托盘，说明大量批次都是22托盘
4. **与之前假设对比**：
   - 旧假设：20-35（均值27.5）
   - FG实际：1-276（均值30.0）- 范围更广
   - R&P实际：1-560（均值22.7）- 有极端值但集中在22

**修改内容**：
1. `src/extract_pallet_distribution.py`（新创建）：
   - 读取Total Shipments的Inbound/Outbound工作表
   - 按Category（FG/R&P）分组统计
   - 拟合正态分布、对数正态分布、三角分布
   - 生成分布图和统计报告

2. `src/dc_simulation.py`：
   - 更新`SYSTEM_PARAMETERS['pallets_distribution']`结构
   - 从单一分布 → 分FG和R&P的三角分布
   - FG: triangular(1, 33, 276)
   - R&P: triangular(1, 22, 560)
   - 更新`_generate_truck()`使用`np.random.triangular()`
   - 基于category选择对应的分布参数

**验证结果**：
- ✅ 成功提取33,280批次数据
- ✅ 生成可视化图表（直方图、箱线图、密度曲线）
- ✅ 仿真成功运行，使用新的托盘分布
- ✅ FG和R&P分别使用各自的实际分布

**生成文件**：
- `pallet_distribution_report.txt`：详细统计报告
- `outputs/figures/pallet_distribution_analysis.png`：可视化分析
- `src/extract_pallet_distribution.py`：提取脚本
- `src/find_pallet_data.py`：数据探索脚本

**建议仿真参数**（已应用）：
```python
'FG': {
    'type': 'triangular',
    'min': 1,
    'mode': 33,
    'max': 276,
    'mean': 30.0,
    'std': 12.3
}
'R&P': {
    'type': 'triangular',
    'min': 1,
    'mode': 22,
    'max': 560,
    'mean': 22.7,
    'std': 9.7
}
```

---

## ✅ 已验证无需修正

### 4. 缓冲区容量（优先级：🟢 MEDIUM）

**验证结果**（2026年1月8日）：
- 实际数据：Total Shipments 2025.xlsx - Inbound（17,103条记录）
- 分析方法：小时级托盘流量聚合，计算95%和99%峰值

**FG缓冲区**：
```
当前配置: 20挂车 × 33托盘 = 660托盘
平均需求: 79 托盘/小时
95%峰值: 135 托盘 (20.5%利用率)
99%峰值: 175 托盘 (26.5%利用率)
历史最大: 609 托盘 (92.3%利用率)
安全余量: 73.5%
```

**R&P缓冲区**：
```
当前配置: 15挂车 × 33托盘 = 495托盘
平均需求: 39 托盘/小时
95%峰值: 68 托盘 (13.7%利用率)
99%峰值: 85 托盘 (17.2%利用率)
历史最大: 622 托盘 (125.7%利用率) ⚠️
安全余量: 82.8%
```

**结论**：
- ✅ FG容量充足（660托盘足够）
- ✅ R&P容量充足（99%时段仅17.2%利用率）
- ⚠️ R&P有1次极端值（622托盘超容量25.7%）
- 需确认622是否为数据异常或真实极端事件
- **当前配置无需修改**

**状态**：✅ 已验证（2026年1月8日）

---

## 🔄 进行中

### 5. FTE活动分配比例（优先级：🟡 MEDIUM）

**当前状态**：
- FG缓冲区：100托盘
- R&P缓冲区：50托盘
- 来源：基于计算（峰值×20%安全余量）

**验证需求**：
- 确认实际物理空间限制
- 检查是否有历史溢出记录
- 评估20%安全余量是否合理

**数据来源**：
- 可能需要现场测量或CAD图纸
- 或历史缓冲区使用数据

### 4. 人力资源动态分配（优先级：⏳ 等待用户数据）

**当前状态**：
- FTE总数：125人（基于实际工时计算，✅已验证）
- 动态分配比例：
  - FG优先：35%
  - R&P优先：65%
  - 来源：假设

**用户反馈**：
> "还有人力资源的分配后续我有一个不同活动的比例统计来分配"

**待办**：
- 等待用户提供活动时间分布数据
- 提取实际FG/R&P人力需求比例
- 更新`FTEManager`的动态分配逻辑

---

## 影响评估

### 码头容量修正的预期影响

**正向影响**：
1. **更准确的约束建模**：
   - R&P码头容量约束现在更紧张
   - FG码头容量更充裕
   - 符合实际运营情况

2. **更可靠的场景分析**：
   - 运营时间缩短对R&P的影响更明显
   - 可以更准确评估加班时段的必要性

3. **更好的资源规划**：
   - 可以区分FG和R&P的瓶颈
   - 有针对性的优化建议

**需要关注**：
1. **R&P等待时间**：
   - 可能比之前模型更长
   - 需要监控是否超出合理范围

2. **码头利用率**：
   - R&P码头可能接近满载
   - FG码头可能有富余

3. **场景排名**：
   - 不同场景的相对表现可能改变
   - 需要重新评估最优方案

---

## 下一步行动

### 即时任务：
1. ✅ 完成托盘分布提取（调试`extract_pallet_distribution.py`）
2. ⏸️ 验证缓冲区容量假设
3. ⏸️ 等待用户FTE活动数据

### 中期任务：
1. 重新运行所有场景（使用修正参数）
2. 对比新旧结果，分析差异
3. 更新DC_SIMULATION_SUMMARY.md文档
4. 准备参数修正影响报告

### 长期任务：
1. 建立参数验证流程
2. 定期更新实际运营数据
3. 持续改进模型准确性

---

## 参考文档

- [PARAMETER_DATA_SOURCES.md](PARAMETER_DATA_SOURCES.md)：参数来源详细分析
- [UPDATED_PARAMETERS.md](UPDATED_PARAMETERS.md)：码头容量修正总结
- `dock_capacity_hourly_analysis.txt`：小时级容量统计
- [DC_SIMULATION_SUMMARY.md](../DC_SIMULATION_SUMMARY.md)：仿真模型总览

---

## 修订历史

| 日期 | 修改内容 | 状态 |
|------|---------|------|
| 2025年 | 初始创建 | - |
| 2025年 | 完成码头容量修正 | ✅ |
| 待定 | 完成托盘分布修正 | 🔄 |
| 待定 | 完成缓冲区验证 | ⏳ |
| 待定 | 完成FTE分配修正 | ⏳ |
