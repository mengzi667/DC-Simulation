# 参数验证分析报告

## 提出的问题

### 1. 缓冲区要验证什么？

**缓冲区的作用**：
- 缓冲区用于暂存入库（Inbound）的托盘
- 卡车卸货后，托盘存入缓冲区
- 出库装车时，从缓冲区取托盘

**需要验证的方面**：

#### ① 容量充足性
**当前配置**：
```python
'buffer_capacity': {
    'rp_trailers': 15,      # R&P缓冲区：15个挂车
    'fg_trailers': 20,      # FG缓冲区：20个挂车
    'pallets_per_trailer': 33  # 每个挂车33托盘
}
```
- FG缓冲区总容量：20 × 33 = **660托盘**
- R&P缓冲区总容量：15 × 33 = **495托盘**

**验证目标**：
1. 峰值需求是否超过容量（是否溢出）
2. 平均利用率是多少
3. 99%分位数需求 vs 总容量
4. 是否有足够的安全余量

#### ② 参数来源合理性
**问题**：当前参数是如何确定的？
- 15和20个挂车的数量是基于什么？
- 33托盘/挂车是标准值还是假设值？
- 是否有实际运营数据支持？

**需要回答**：
- ✅ 基于实际物理限制（场地空间）
- ✅ 基于历史数据（峰值需求统计）
- ❌ 还是纯粹假设/估算？

#### ③ 动态性能
**验证内容**：
- 缓冲区占用率的时间变化
- 高峰时段 vs 低峰时段
- 缓冲区周转速度
- 是否存在长时间满载或空载

---

### 2. 为什么到达一定是泊松分布？怎么确定的？

#### 问题的本质

**当前假设**：
```python
# 代码中使用泊松分布生成到达
num_arrivals = np.random.poisson(arrival_rates[category][hour])
```

**泊松分布的适用条件**：
1. **独立性**：各次到达相互独立
2. **平稳性**：单位时间内到达率恒定
3. **稀有性**：短时间内不会同时多次到达
4. **无记忆性**：过去的到达不影响未来

**关键问题**：
- ❓ 卡车到达真的满足这些条件吗？
- ❓ 有没有验证过实际数据？
- ❓ 如果不是泊松分布，应该用什么分布？

---

## 验证分析

### 方法1：方差-均值比检验

**泊松分布的关键特征**：
- **均值 = 方差**
- 如果 Var/Mean ≈ 1.0，支持泊松分布
- 如果 Var/Mean < 1.0，可能是负二项分布（过离散）
- 如果 Var/Mean > 1.0，可能是泊松分布的混合

**基于Total Shipments 2025数据的初步分析**：

```
FG到达过程（3,537个观测）：
- 均值 λ: 3.17 卡车/小时
- 方差: 1.51
- 方差/均值比: 0.48
- ⚠️  方差 << 均值（应该≈1.0）

R&P到达过程（3,313个观测）：
- 均值 λ: 1.50 卡车/小时
- 方差: 0.45
- 方差/均值比: 0.30
- ⚠️  方差 << 均值（应该≈1.0）
```

**结论**：
- ❌ **方差显著小于均值** → 不完全符合泊松分布
- 实际到达比泊松分布**更规律**（less random）
- 可能原因：
  - 预约制度：卡车有固定时段
  - 批次调度：避免同时到达
  - 容量限制：码头饱和时延迟到达

### 方法2：分布拟合检验

#### 卡方拟合优度检验
比较观测频率 vs 理论泊松分布频率

#### K-S检验
检验经验分布 vs 理论泊松分布

#### 结果预测（基于方差/均值比）：
- 统计检验可能会**拒绝泊松分布**
- 但泊松分布可能仍是**合理的近似**

---

## 对仿真的影响

### 如果不是泊松分布，会怎样？

#### 情况1：实际更规律（Var < Mean）
- 泊松分布**高估了随机性**
- 仿真中的峰值负荷会**偏高**
- 等待时间估计可能**偏悲观**
- 建议：使用确定性到达 或 低方差分布

#### 情况2：实际更随机（Var > Mean）
- 泊松分布**低估了随机性**
- 仿真中的峰值负荷会**偏低**
- 等待时间估计可能**偏乐观**  
- 建议：使用负二项分布 或 复合泊松

---

## 建议的改进方向

### 短期（立即可做）

#### 1. 验证到达分布
```python
# 运行验证脚本
python src/validate_arrival_and_buffer.py
```
- 检查方差/均值比
- 进行统计检验
- 绘制Q-Q图对比

#### 2. 验证缓冲区容量
从Inbound Shipments提取：
- 按小时统计入库托盘数
- 计算95%、99%分位数
- 对比当前容量（660/495托盘）

### 中期（需要数据）

#### 3. 考虑替代分布模型

**选项A：时段分层**
```python
# 不同时段使用不同参数
'arrival_patterns': {
    'morning_peak': (7-9h, higher λ, lower variance),
    'noon': (11-13h, medium λ, medium variance),
    'afternoon': (14-17h, medium λ, low variance),
    'evening': (18-22h, lower λ, higher variance)
}
```

**选项B：混合分布**
```python
# 80%预约到达（确定性） + 20%临时到达（泊松）
if random() < 0.8:
    arrival_time = scheduled_time
else:
    arrival_time = poisson_arrival()
```

**选项C：负二项分布**（如果Var > Mean）
```python
num_arrivals = np.random.negative_binomial(n, p)
```

#### 4. 基于实际调度数据
如果有预约系统的数据：
- 使用实际预约时段
- 添加随机延迟（正态分布±15分钟）
- 更准确地反映实际运营

### 长期（模型优化）

#### 5. 动态缓冲区模型
当前是静态容量，考虑：
- 不同时段的容量变化
- 与码头容量的协调
- 溢出后的应急措施

#### 6. 到达-服务联合建模
考虑：
- 到达率与码头占用率的关系
- 高峰时段的到达抑制效应
- 预约系统的调控作用

---

## 数据需求清单

### 已有数据
✅ Total Shipments 2025（出/入库时间戳）
✅ Timeslot W1-W48（码头容量）
✅ KPI sheet（效率数据）

### 缺失数据（建议收集）
❌ 预约 vs 临时到达比例
❌ 实际 vs 预约时间偏差
❌ 缓冲区历史占用率数据
❌ 溢出事件记录（如果有）
❌ 高峰时段拒绝/延迟到达记录

---

## 总结与建议

### 关键发现

1. **到达分布假设需要验证**
   - 当前直接使用泊松分布
   - 初步分析显示Var << Mean（不符合泊松特征）
   - 可能原因：预约制度导致到达更规律

2. **缓冲区容量是假设值**
   - FG: 660托盘, R&P: 495托盘
   - 需要验证是否基于实际数据
   - 需要检查峰值需求是否超容量

### 优先行动

**Level 1（必做）**：
1. 运行`validate_arrival_and_buffer.py`获得验证报告
2. 查看实际到达分布 vs 泊松分布的拟合度
3. 检查缓冲区峰值需求 vs 当前容量

**Level 2（建议）**：
4. 如果方差/均值比偏离1.0显著（<0.7或>1.3），考虑替代分布
5. 收集预约系统数据，建立更准确的到达模型
6. 验证缓冲区参数（15/20挂车）的来源

**Level 3（长期）**：
7. 建立到达-服务-缓冲的联合模型
8. 考虑季节性、星期效应
9. 优化缓冲区容量配置

### 对当前仿真的影响评估

**如果到达实际更规律（Var < Mean）**：
- ✅ 好消息：当前结果可能**偏保守**
- ✅ 等待时间实际可能更短
- ✅ SLA达成率可能更高
- ⚠️  但不应过度依赖这个优势

**如果缓冲区容量不足**：
- ❌ 模型可能低估了托盘溢出风险
- ❌ Inbound高峰时可能出现拥堵
- ❌ 需要调整容量或增加应急措施

### 下一步

运行验证脚本后，根据结果决定：
- 是否调整到达分布模型
- 是否调整缓冲区容量
- 是否需要收集更多数据

---

**文档版本**: 1.0  
**创建日期**: 2026年1月8日  
**状态**: 待验证分析完成
